{"version":3,"sources":["../../src/exact/client/scheme.ts"],"sourcesContent":["import {\n  getSetComputeUnitLimitInstruction,\n  setTransactionMessageComputeUnitPrice,\n} from \"@solana-program/compute-budget\";\nimport { TOKEN_PROGRAM_ADDRESS } from \"@solana-program/token\";\nimport {\n  fetchMint,\n  findAssociatedTokenPda,\n  getTransferCheckedInstruction,\n  TOKEN_2022_PROGRAM_ADDRESS,\n} from \"@solana-program/token-2022\";\nimport {\n  appendTransactionMessageInstructions,\n  createTransactionMessage,\n  getBase64EncodedWireTransaction,\n  partiallySignTransactionMessageWithSigners,\n  pipe,\n  prependTransactionMessageInstruction,\n  setTransactionMessageFeePayer,\n  setTransactionMessageLifetimeUsingBlockhash,\n  type Address,\n} from \"@solana/kit\";\nimport type { PaymentPayload, PaymentRequirements, SchemeNetworkClient } from \"@x402/core/types\";\nimport {\n  DEFAULT_COMPUTE_UNIT_LIMIT,\n  DEFAULT_COMPUTE_UNIT_PRICE_MICROLAMPORTS,\n} from \"../../constants\";\nimport type { ClientSvmConfig, ClientSvmSigner } from \"../../signer\";\nimport type { ExactSvmPayloadV2 } from \"../../types\";\nimport { createRpcClient } from \"../../utils\";\n\n/**\n * SVM client implementation for the Exact payment scheme.\n */\nexport class ExactSvmScheme implements SchemeNetworkClient {\n  readonly scheme = \"exact\";\n\n  /**\n   * Creates a new ExactSvmClient instance.\n   *\n   * @param signer - The SVM signer for client operations\n   * @param config - Optional configuration with custom RPC URL\n   * @returns ExactSvmClient instance\n   */\n  constructor(\n    private readonly signer: ClientSvmSigner,\n    private readonly config?: ClientSvmConfig,\n  ) {}\n\n  /**\n   * Creates a payment payload for the Exact scheme.\n   *\n   * @param x402Version - The x402 protocol version\n   * @param paymentRequirements - The payment requirements\n   * @returns Promise resolving to a payment payload\n   */\n  async createPaymentPayload(\n    x402Version: number,\n    paymentRequirements: PaymentRequirements,\n  ): Promise<Pick<PaymentPayload, \"x402Version\" | \"payload\">> {\n    const rpc = createRpcClient(paymentRequirements.network, this.config?.rpcUrl);\n\n    const tokenMint = await fetchMint(rpc, paymentRequirements.asset as Address);\n    const tokenProgramAddress = tokenMint.programAddress;\n\n    if (\n      tokenProgramAddress.toString() !== TOKEN_PROGRAM_ADDRESS.toString() &&\n      tokenProgramAddress.toString() !== TOKEN_2022_PROGRAM_ADDRESS.toString()\n    ) {\n      throw new Error(\"Asset was not created by a known token program\");\n    }\n\n    const [sourceATA] = await findAssociatedTokenPda({\n      mint: paymentRequirements.asset as Address,\n      owner: this.signer.address,\n      tokenProgram: tokenProgramAddress,\n    });\n\n    const [destinationATA] = await findAssociatedTokenPda({\n      mint: paymentRequirements.asset as Address,\n      owner: paymentRequirements.payTo as Address,\n      tokenProgram: tokenProgramAddress,\n    });\n\n    const transferIx = getTransferCheckedInstruction(\n      {\n        source: sourceATA,\n        mint: paymentRequirements.asset as Address,\n        destination: destinationATA,\n        authority: this.signer,\n        amount: BigInt(paymentRequirements.amount),\n        decimals: tokenMint.data.decimals,\n      },\n      { programAddress: tokenProgramAddress },\n    );\n\n    // Facilitator must provide feePayer to cover transaction fees\n    const feePayer = paymentRequirements.extra?.feePayer as Address;\n    if (!feePayer) {\n      throw new Error(\"feePayer is required in paymentRequirements.extra for SVM transactions\");\n    }\n\n    const { value: latestBlockhash } = await rpc.getLatestBlockhash().send();\n\n    const tx = pipe(\n      createTransactionMessage({ version: 0 }),\n      tx => setTransactionMessageComputeUnitPrice(DEFAULT_COMPUTE_UNIT_PRICE_MICROLAMPORTS, tx),\n      tx => setTransactionMessageFeePayer(feePayer, tx),\n      tx =>\n        prependTransactionMessageInstruction(\n          getSetComputeUnitLimitInstruction({ units: DEFAULT_COMPUTE_UNIT_LIMIT }),\n          tx,\n        ),\n      tx => appendTransactionMessageInstructions([transferIx], tx),\n      tx => setTransactionMessageLifetimeUsingBlockhash(latestBlockhash, tx),\n    );\n\n    const signedTransaction = await partiallySignTransactionMessageWithSigners(tx);\n    const base64EncodedWireTransaction = getBase64EncodedWireTransaction(signedTransaction);\n\n    const payload: ExactSvmPayloadV2 = {\n      transaction: base64EncodedWireTransaction,\n    };\n\n    return {\n      x402Version,\n      payload,\n    };\n  }\n}\n"],"mappings":";;;;;;;AAAA;AAAA,EACE;AAAA,EACA;AAAA,OACK;AACP,SAAS,6BAA6B;AACtC;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,OACK;AACP;AAAA,EACE;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,OAEK;AAaA,IAAM,iBAAN,MAAoD;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAUzD,YACmB,QACA,QACjB;AAFiB;AACA;AAXnB,SAAS,SAAS;AAAA,EAYf;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EASH,MAAM,qBACJ,aACA,qBAC0D;AAC1D,UAAM,MAAM,gBAAgB,oBAAoB,SAAS,KAAK,QAAQ,MAAM;AAE5E,UAAM,YAAY,MAAM,UAAU,KAAK,oBAAoB,KAAgB;AAC3E,UAAM,sBAAsB,UAAU;AAEtC,QACE,oBAAoB,SAAS,MAAM,sBAAsB,SAAS,KAClE,oBAAoB,SAAS,MAAM,2BAA2B,SAAS,GACvE;AACA,YAAM,IAAI,MAAM,gDAAgD;AAAA,IAClE;AAEA,UAAM,CAAC,SAAS,IAAI,MAAM,uBAAuB;AAAA,MAC/C,MAAM,oBAAoB;AAAA,MAC1B,OAAO,KAAK,OAAO;AAAA,MACnB,cAAc;AAAA,IAChB,CAAC;AAED,UAAM,CAAC,cAAc,IAAI,MAAM,uBAAuB;AAAA,MACpD,MAAM,oBAAoB;AAAA,MAC1B,OAAO,oBAAoB;AAAA,MAC3B,cAAc;AAAA,IAChB,CAAC;AAED,UAAM,aAAa;AAAA,MACjB;AAAA,QACE,QAAQ;AAAA,QACR,MAAM,oBAAoB;AAAA,QAC1B,aAAa;AAAA,QACb,WAAW,KAAK;AAAA,QAChB,QAAQ,OAAO,oBAAoB,MAAM;AAAA,QACzC,UAAU,UAAU,KAAK;AAAA,MAC3B;AAAA,MACA,EAAE,gBAAgB,oBAAoB;AAAA,IACxC;AAGA,UAAM,WAAW,oBAAoB,OAAO;AAC5C,QAAI,CAAC,UAAU;AACb,YAAM,IAAI,MAAM,wEAAwE;AAAA,IAC1F;AAEA,UAAM,EAAE,OAAO,gBAAgB,IAAI,MAAM,IAAI,mBAAmB,EAAE,KAAK;AAEvE,UAAM,KAAK;AAAA,MACT,yBAAyB,EAAE,SAAS,EAAE,CAAC;AAAA,MACvC,CAAAA,QAAM,sCAAsC,0CAA0CA,GAAE;AAAA,MACxF,CAAAA,QAAM,8BAA8B,UAAUA,GAAE;AAAA,MAChD,CAAAA,QACE;AAAA,QACE,kCAAkC,EAAE,OAAO,2BAA2B,CAAC;AAAA,QACvEA;AAAA,MACF;AAAA,MACF,CAAAA,QAAM,qCAAqC,CAAC,UAAU,GAAGA,GAAE;AAAA,MAC3D,CAAAA,QAAM,4CAA4C,iBAAiBA,GAAE;AAAA,IACvE;AAEA,UAAM,oBAAoB,MAAM,2CAA2C,EAAE;AAC7E,UAAM,+BAA+B,gCAAgC,iBAAiB;AAEtF,UAAM,UAA6B;AAAA,MACjC,aAAa;AAAA,IACf;AAEA,WAAO;AAAA,MACL;AAAA,MACA;AAAA,IACF;AAAA,EACF;AACF;","names":["tx"]}